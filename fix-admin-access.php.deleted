<?php

/**
 * Fix Admin Access Script
 * Run this with: php fix-admin-access.php
 */

require_once 'vendor/autoload.php';

$app = require_once 'bootstrap/app.php';
$app->make(\Illuminate\Contracts\Console\Kernel::class)->bootstrap();

use App\Models\User;
use Illuminate\Support\Facades\Hash;

echo "🔧 Fixing Admin Access Issues...\n\n";

// Check if we have any users
$userCount = User::count();
echo "Current users in database: {$userCount}\n";

if ($userCount === 0) {
    echo "No users found. Creating admin user...\n";
    
    $admin = User::create([
        'name' => 'Admin User',
        'email' => 'admin@noburesidences.com',
        'password' => Hash::make('admin123'),
        'role' => 'admin',
        'email_verified_at' => now(),
    ]);
    
    echo "✅ Admin user created!\n";
    echo "   Email: admin@noburesidences.com\n";
    echo "   Password: admin123\n";
} else {
    // Check if any admin exists
    $adminCount = User::where('role', 'admin')->count();
    
    if ($adminCount === 0) {
        echo "No admin users found. Making first user an admin...\n";
        
        $firstUser = User::first();
        $firstUser->update(['role' => 'admin']);
        
        echo "✅ Made user '{$firstUser->name}' ({$firstUser->email}) an admin!\n";
    } else {
        echo "✅ Admin users already exist ({$adminCount} found)\n";
        
        $admins = User::where('role', 'admin')->get();
        foreach ($admins as $admin) {
            echo "   - {$admin->name} ({$admin->email})\n";
        }
    }
}

echo "\n🎯 Admin access should now be working!\n";
echo "   Navigate to: http://127.0.0.1:8000/admin/dashboard\n\n";

// Check for common issues
echo "🔍 Checking for common issues...\n\n";

// Check if migrations have run
try {
    $tableExists = \Illuminate\Support\Facades\Schema::hasTable('users');
    if ($tableExists) {
        echo "✅ Users table exists\n";
        
        $hasRoleColumn = \Illuminate\Support\Facades\Schema::hasColumn('users', 'role');
        if ($hasRoleColumn) {
            echo "✅ Role column exists in users table\n";
        } else {
            echo "❌ Role column missing in users table. Run: php artisan migrate\n";
        }
    } else {
        echo "❌ Users table doesn't exist. Run: php artisan migrate\n";
    }
} catch (Exception $e) {
    echo "❌ Database connection issue: " . $e->getMessage() . "\n";
    echo "   Check your .env database configuration\n";
}

echo "\n";
